<!DOCTYPE html>

<html>
	<head>
	    <meta charset="utf-8">
	    <title>lab09</title>
		<script src="https://d3js.org/d3.v4.js"></script>
		<meta http-equiv="Access-Control-Allow-Origin" content="*" />
	</head>
	<body>
		<div style="top: 20%;left: 30%;position: absolute;z-index: -1;display:block; margin: 0 auto;">
			<video id="myVideo" src="videoplayback.mp4" controls loop></video>
		</div>
		<div id = "srt" style="top: 20%;left: 30%;display:block;position: absolute;margin: 0 auto;">
			<!--<p>歌詞</p>-->
		</div>
		<div id = "time" style="top: 20%;left: 30%;display:block;position: absolute;margin: 0 auto;">
			<!--<p>歌詞</p>-->
		</div>
		<script type="text/javascript">

			var myarray = [];
			var key,begin,end,duration,text;
			var totalTime = [];
			var myVideo = document.getElementById("myVideo");
			var w;
			var h;
			var svgTime;
			var timer;
			myVideo.addEventListener('loadedmetadata', function(e){
				    //console.log(myVideo.videoWidth, myVideo.videoHeight);
				    myVideo.volume = 0.1;
				    myVideo.autoplay = true;
				    myVideo.controls = false;
				    w = myVideo.videoWidth;
					h = myVideo.videoHeight;
					svgTime = d3.select("body")
								.select("#time")
								.append("svg") //產生svg
								.attr("id","svgTime")
								.attr("width",w)
								.attr("height",h)
								.attr("z-index",1)
								.attr("viewbox",function(){ //?
									return "0, 0, " + w + ", "+ h;
								})
								/*.append("text")
								.text("here")
								.attr("x",w-40)
								.attr("y",30)
								.attr("font-size",16)
								.attr("fill","none")
								.attr("stroke","blue")
								.attr("stroke-width",3)*/
				setTimeout(function(){
				    timer = setInterval(timeList, 1000);
				    setInterval(subtitle(myVideo), myVideo.duration);
				},3500);
				    //timer = setInterval(timeList, 1000);
				    //setInterval(subtitle(myVideo), myVideo.duration);
				    //subtitle(myVideo);
				    //setInterval(timeList, 1000);
			});
			//another method
			//var minute,second;
			//firefox設定about:config autoplay,uniq
			//先讀檔(.srt轉.csv的)
			
			var time = 0;
			//setInterval(timeList, 1000);

			function timeList(){
				//console.log("time in");
				d3.select("#svgTime")
					.append("text")
					.text(function(){
						//console.log(time)
						if(time < 10){
							return "00:0" + time;
						}
						else if(time >= 10 && time < 60){
							return "00:" + time;
						}
						else if(time >= 60){
							var minute = time / 60;
							if (time / 60 < 10) {
								return "0" + minute + ":0" + time % 60;
							}
							else{
								return "0" + minute + ":" + time / 10 + "" + time % 60;
							}
						}
						//return d;
					})
					.attr("font-size",16)
					.attr("fill","none")
					.attr("stroke","white")
					.attr("stroke-width",1)
					.attr("x", w - 40)
					.attr("y", 30)
					.attr("opacity",1)
					.transition()
					.delay(10)
					.duration(490)
					.attr("opacity",1)
					.transition()
					.delay(490)
					.duration(10)
					.attr("opacity",0)
					.remove()
				time++;
				if (time >= myVideo.duration) {
					time =0;
				}
			}


			function subtitle(myVideo){
				d3.text("[Toolbxs]music.srt",function(data){
					//console.log(data);
					console.log("---------");
					var parsedCSV = d3.csvParseRows(data);

					console.log(parsedCSV);

					d3.select("#srt")
						.selectAll("p")
						.data(parsedCSV) //或data
						.enter()//執行次數=srt數吧
						.append("p")
						.text(function(d,i){
							//歌詞處理
							//return d;
							if(!isNaN(d) && d != ""){
								key = parseInt(d) - 1;
							}
							else if(d == ""){
								myarray.push({
									"key": key,
									"begin": begin,
									"end": end,
									"duration": end - begin,
									"text": text
								});
							}
							else if(d.length == 3){ //,分隔
								begin = (parseInt(d[0][3]) * 10 + parseInt(d[0][4])) * 60 + (parseInt(d[0][6]) * 10 + parseInt(d[0][7])) + (parseInt(d[1][0]) * 100 + parseInt(d[1][1]) * 10 + parseInt(d[1][2])) * 0.001;
								end = (parseInt(d[1][11]) * 10 + parseInt(d[1][12])) * 60 + (parseInt(d[1][14]) * 10 + parseInt(d[1][15])) + parseInt(d[2] * 0.001);

							}
							else{
								text = d;
							}
						})
						console.log(myarray);

						
						var svg = d3.select("body")
									.select("#srt")
									.append("svg") //產生svg
									.attr("width",w)
									.attr("height",h)
									.attr("z-index",1)
									.attr("viewbox",function(){ //?
										return "0, 0, " + w + ", "+ h;
									})
						

						svg.append("rect")
							.attr("width",w)
							.attr("height",h)
							.attr("fill","none")
							.attr("stroke","black")

						

						svg.selectAll("text")
							.data(myarray)
							.enter()
							.append("text")
							.text(function(d){
								return d.text[0];
							})
							.attr("font-size",24)
							.attr("fill","none")
							.attr("stroke","red")
							.attr("x",w / 2)
							.attr("y",function(d,i){
								if(h - i * 7 < 0){
									return 24;
								}
								else if(h - i * 7 > myVideo.videoHeight - 24){
									return myVideo.videoHeight - 24;
								}
								return h - i * 7;
							})
							.attr('begin', function(d, i){
					       		return d.begin;
					        })
					        .attr('end', function(d, i){
					       		return d.end;
					        })
							.attr("text-anchor","middle")
							.style("font-family","MS PGothic")
							.attr("opacity",0)
							.transition()
							.delay(function(d){
								return (d.begin - d.duration / 2) * 1000 - d.text.length* 15;
							})
							.duration(function(d){
								return (d.duration + d.duration / 2) * 800;
							})
							.attr("opacity",1)
							.transition()
							.duration(function(d){
								return (d.duration / 2 * 800);
							})
							.delay(function(d){
								return d.text.length * 920;
							})//改
							.attr("opacity",0)
					})
			}
		</script>
	</body>
	
</html>
